<!DOCTYPE html>

<head>
  <meta charset="utf-8" />
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<style>
  .error {
    color: #D8000C;
    background-color: #FFBABA;
  }

  div.tooltip {
    color: #222;
    background-color: #fff;
    padding: 0.5em;
    text-shadow: #f5f5f5 0 1px 0;
    border-radius: 2px;
    opacity: 0.9;
    position: absolute;
  }
</style>

<body>
  <div id="app"></div>
  <div id="my_dataviz"></div>
  <div id="cocher"></div>
  <span class="error" id="errorCheckbox"></span>
  <script>
    async function load_data() {

      var services = {};
      var dechets = {};
      var data = {
        "Total_dechets": 0
      };
      let data_ = await d3.csv("https://koumoul.com/s/data-fair/api/v1/datasets/sinoe-(r)-destination-des-dechets-collectes-en-decheterie-par-type-de-traitement/full");
      for (o of data_) {
        if (parseInt(o.C_REGION) == 97 || parseInt(o.C_REGION) == 94) continue;


        if (!(o.C_REGION in data)) {
          data[o.C_REGION] = {
            "name": o.L_REGION,
            "services": {},
            "Total_dechets": 0,
            "get_name": function () { return this.name },
            "get_total_dechets": function () { return this.Total_dechets },
            "get_year": function (year) { return this[year] }
          };
        }

        if (!(o.ANNEE in data)) {
          data[o.ANNEE] = {};
          data[o.ANNEE].get_total_dechets = function () { return this.Total_dechets };
          data[o.ANNEE]["get_service"] = function (service) { return this.services[service] };
          data[o.ANNEE]["get_dechet"] = function (dechet) { return this[dechet]["Total_dechets"] };
          data[o.ANNEE]["Total_dechets"] = 0;
          data[o.ANNEE]["services"] = {};
        }

        if (!(o.ANNEE in data[o.C_REGION])) {
          data[o.C_REGION][o.ANNEE] = { "get_total_dechets": function () { return this.Total_dechets } };
          data[o.C_REGION][o.ANNEE]["Total_dechets"] = 0;
          data[o.C_REGION][o.ANNEE]["services"] = {};
          data[o.C_REGION][o.ANNEE]["get_service"] = function (service) { return this.services[service] };
          data[o.C_REGION][o.ANNEE]["get_dechet"] = function (dechet) { return this[dechet]["Total_dechets"] };
        }

        if (!(o.C_TYP_REG_DECHET in data[o.C_REGION])) {
          data[o.C_REGION][o.C_TYP_REG_DECHET] = {};
          data[o.C_REGION][o.C_TYP_REG_DECHET]["Total_dechets"] = 0;
          data[o.C_REGION][o.C_TYP_REG_DECHET]["services"] = {};
        }

        if (!(o.C_TYP_REG_DECHET in data[o.C_REGION][o.ANNEE])) {
          data[o.C_REGION][o.ANNEE][o.C_TYP_REG_DECHET] = {};
          data[o.C_REGION][o.ANNEE][o.C_TYP_REG_DECHET]["services"] = {};
          data[o.C_REGION][o.ANNEE][o.C_TYP_REG_DECHET]["Total_dechets"] = 0;
        }

        if (!(o.C_TYP_REG_DECHET in data[o.ANNEE])) {
          data[o.ANNEE][o.C_TYP_REG_DECHET] = {};
          data[o.ANNEE][o.C_TYP_REG_DECHET]["services"] = {};
          data[o.ANNEE][o.C_TYP_REG_DECHET]["Total_dechets"] = 0;

        }

        if (!(o.C_TYP_REG_SERVICE in data[o.ANNEE][o.C_TYP_REG_DECHET]["services"])) {
          data[o.ANNEE][o.C_TYP_REG_DECHET]["services"][o.C_TYP_REG_SERVICE] = 0;
        }

        if (!(o.C_TYP_REG_SERVICE in data[o.C_REGION][o.ANNEE][o.C_TYP_REG_DECHET]["services"])) {
          data[o.C_REGION][o.ANNEE][o.C_TYP_REG_DECHET]["services"][o.C_TYP_REG_SERVICE] = 0;
        }

        if (!(o.C_TYP_REG_SERVICE in data[o.C_REGION][o.C_TYP_REG_DECHET]["services"])) {
          data[o.C_REGION][o.C_TYP_REG_DECHET]["services"][o.C_TYP_REG_SERVICE] = 0;
        }

        if (!(o.C_TYP_REG_SERVICE in data[o.C_REGION][o.ANNEE]["services"])) {
          data[o.C_REGION][o.ANNEE]["services"][o.C_TYP_REG_SERVICE] = 0;
        }

        if (!(o.C_TYP_REG_SERVICE in data[o.ANNEE]["services"])) {
          data[o.ANNEE]["services"][o.C_TYP_REG_SERVICE] = 0;
        }

        if (!(o.C_TYP_REG_SERVICE in data[o.C_REGION]["services"])) {
          data[o.C_REGION]["services"][o.C_TYP_REG_SERVICE] = 0;
        }

        var dechet_add = parseFloat(o.TONNAGE_DECH);
        data[o.C_REGION]["services"][o.C_TYP_REG_SERVICE] += dechet_add;
        data[o.ANNEE]["services"][o.C_TYP_REG_SERVICE] += dechet_add;
        data[o.C_REGION][o.ANNEE]["services"][o.C_TYP_REG_SERVICE] += dechet_add;
        data[o.C_REGION][o.C_TYP_REG_DECHET]["services"][o.C_TYP_REG_SERVICE] += dechet_add;
        data[o.C_REGION][o.ANNEE][o.C_TYP_REG_DECHET]["services"][o.C_TYP_REG_SERVICE] += dechet_add;
        data[o.ANNEE][o.C_TYP_REG_DECHET]["services"][o.C_TYP_REG_SERVICE] += dechet_add;
        data[o.ANNEE][o.C_TYP_REG_DECHET]["Total_dechets"] += dechet_add;
        data[o.C_REGION][o.ANNEE][o.C_TYP_REG_DECHET]["Total_dechets"] += dechet_add;
        data[o.C_REGION][o.C_TYP_REG_DECHET]["Total_dechets"] += dechet_add;
        data[o.ANNEE]["Total_dechets"] += dechet_add;
        data[o.C_REGION][o.ANNEE]["Total_dechets"] += dechet_add;
        data[o.C_REGION]["Total_dechets"] += dechet_add;
        data[o.ANNEE]["Total_dechets"] += dechet_add;
        data["Total_dechets"] += dechet_add;

        if (!(o.C_TYP_REG_DECHET in dechets)) {
          dechets[o.C_TYP_REG_DECHET] = o.L_TYP_REG_DECHET;
        }

        if (!(o.C_TYP_REG_SERVICE in services)) {
          services[o.C_TYP_REG_SERVICE] = o.L_TYP_REG_SERVICE;
        }

      }
      data.services = services;
      data.dechets = dechets;
      // FUNCTIONS 
      data.get_total_dechets = function () { return this.Total_dechets };
      data.get_region_list = function () { return [11, 24, 27, 28, 32, 44, 52, 53, 75, 76, 84, 93] };
      data.get_year_list = function () { return [2009, 2011, 2013, 2015, 2017] };
      data.get_region = function (region) {
        if (region === undefined) return {
          11: this[11],
          24: this[24],
          27: this[27],
          28: this[28],
          32: this[32],
          44: this[44],
          52: this[52],
          53: this[53],
          75: this[75],
          76: this[76],
          84: this[84],
          93: this[93]
        }
        else return this[region];
      };
      data.get_year = function (year) { return this[year] };
      data.get_type_dechets = function () { return this.dechets };
      data.get_type_services = function () { return this.services };
      data.get_name_region = function () {
        return {
          11: "Ile-de-France",
          24: "Centre-Val de Loire",
          27: "Bourgogne-Franche-Comté",
          28: "Normandie",
          32: "Hauts-de-France",
          44: "Grand-Est",
          52: "Pays de la Loire",
          53: "Bretagne",
          75: "Nouvelle-Aquitaine",
          76: "Occitanie",
          84: "Auvergne-Rhône-Alpes",
          93: "PACA"

        };

      };

      data.get_name_region_string = function () {
        return ["Ile-de-France",
          "Centre-Val de Loire",
          "Bourgogne-Franche-Comté",
          "Normandie",
          "Hauts-de-France",
          "Grand-Est",
          "Pays de la Loire",
          "Bretagne",
          "Nouvelle-Aquitaine",
          "Occitanie",
          "Auvergne-Rhône-Alpes",
          "PACA"];
      };


      console.log(data.get_region(11).get_year(2009).get_dechet("02B"));
      return data;
    }

  </script>
  <script>

    var data;
    var myStack = [];

    var colorRange = ['#e41a1c', '#377eb8', '#4daf4a', '#ff9900', '#800000'];
    var margin = { top: 10, right: 200, bottom: 150, left: 70 },
      width = 860 - margin.left - margin.right,
      height = 400 - margin.top - margin.bottom;

    var svg = d3.select("#my_dataviz")
      .append("svg")
      .attr('id', 'svg')
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Add X axis
    var x = d3.scaleBand()
      .range([0, width])
      .padding([0.2]);

    svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .attr('class', 'axis x')
      .call(d3.axisBottom(x).tickSizeOuter(0))
      .selectAll("text")
      .style("text-anchor", "end")
      .attr("dx", "-.8em")
      .attr("dy", ".15em")
      .attr("transform", "rotate(-65)")

    // Add Y axis
    var y = d3.scaleLinear()
      .range([height, 0]);

    svg.append("g")
      .attr('class', 'axis y')
      .call(d3.axisLeft(y));

    // color palette = one color per subgroup
    var color = d3.scaleOrdinal()
      .domain(['2009', '2011', '2013', '2015', '2017'])
      .range(['#e41a1c', '#377eb8', '#4daf4a', '#ff9900', '#800000'])

    // add legend   
    let legendRectSize = 20;
    let legendSpacing = 20;
    var legend = svg.selectAll('.legend')
      .data(color.domain().reverse())
      .enter()
      .append('g')
      .attr('class', 'legend')
      .attr('transform', function (d, i) {
        var height = legendRectSize + legendSpacing;
        var offset = height * color.domain().length / 2;
        var horz = -2 * legendRectSize + width + margin.left;
        var vert = 215 + i * height - offset;
        return 'translate(' + horz + ',' + vert + ')';
      });

    legend.append('rect')
      .attr('width', legendRectSize)
      .attr('height', legendRectSize)
      .style('fill', color)
      .style('stroke', color);

    legend.append('text')
      .attr('x', legendRectSize + legendSpacing)
      .attr('y', 16 + legendRectSize - legendSpacing)
      .data(['2009', '2011', '2013', '2015', '2017'].reverse())
      .text(function (d, i) {
        return d;
      });

    async function init() {

      // recuperation des données
      data = await load_data();

      // creation de la stack custom
      myStack = dataToStack(data.get_year_list(), data.get_region_list())

      chosenYears = data.get_year_list();
      console.log(chosenYears);
      // trie de la stack
      let descOrder = myStack[myStack.length - 1].sort((a, b) => {
        return b[1] - a[1];
      });

      let descOrderString = descOrder.map((value, index) => {
        return value[2];
      });

      update(data.get_year_list(), data.get_region_list());

      checkbox_create();

    }

    function update(years, regions) {

      // new stack creation
      let newStack = dataToStack(years, regions)
      // console.log(newStack);

      // update x axis
      x.domain(newStack[0].map((value, index) => { return value[2] }));
      d3.select(".axis.x")
        .transition()
        .duration(750)
        .call(d3.axisBottom(x).tickSizeOuter(0))
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-65)")

      // update y axis
      let maxY = d3.max(newStack[newStack.length - 1], (d) => { return d3.max(d); });
      y.domain([0, maxY * 1.2]);
      svg.select(".axis.y")
        .transition()
        .duration(750)
        .call(d3.axisLeft(y))


      // remove all bargroups
      svg.selectAll(".bar-group").remove();

      // DATA JOIN
      // Join new data with old elements, if any.
      let newBarGroups = svg.selectAll('.bar-group')
        .data(newStack)
        .enter().append('g')
        .classed('bar-group', true)
        .attr("fill", function (d) {
          //console.log(d[0][3]);
          return color(d[0][3]);
        });


      // create new bars
      newBarGroups
        .selectAll('rect')
        .data(function (d) { return d; })
        .enter().append('rect')
        .attr("x", function (d) { return x(d[2]); })
        .attr("y", function (d) { return y(d[1]); })
        .attr("height", function (d) { return y(d[0]) - y(d[1]); })
        .attr("width", x.bandwidth())
        .on("mousemove", mousemove)
        .on("mouseleave", mouseleave);

    }

    function dataToStack(years, regions) {

      let newStack = [];

      // creation de la stack custom
      let previousValues = {};

      // init previous values dict with zeros
      for (let region of regions) {
        previousValues[region] = 0;
      }

      for (let year of years) {
        let yearStack = [];
        for (let region of regions) {
          let yearRegionStack = [];
          yearRegionStack.push(previousValues[region]);
          previousValues[region] += data.get_region(region).get_year(year).get_total_dechets();
          yearRegionStack.push(previousValues[region]);
          yearRegionStack.push(data.get_name_region()[region]);
          yearRegionStack.push(year);
          yearRegionStack.push(region);
          yearStack.push(yearRegionStack);
        }
        newStack.push(yearStack);
      }

      return newStack;
    }

    init()
  </script>

  <script>
    var tooltip = d3.select("#my_dataviz")
      .append("div")
      .style("opacity", 0)
      .attr("class", "tooltip")
      .style("background-color", "white")
      .style("border", "solid")
      .style("border-width", "1px")
      .style("border-radius", "5px")
      .style("padding", "10px");

    var mousemove = function (event, d) {
      var subgroupName = d[2];
      var subgroupValue = Math.floor(d[1] - d[0]);
      var mousePosition = d3.pointer(event);
      tooltip
        .style("opacity", 1)
        .attr(
          "style",
          "left:" +
          (mousePosition[0] + 15) +
          "px; top:" +
          (mousePosition[1] - 35) +
          "px"
        )
        .html("Région: " + subgroupName + "<br>" + "Valeur: " + subgroupValue + " tonnes")
    }
    var mouseleave = function (d) {
      tooltip
        .style("opacity", 0)
    }

    function cocher_case(cas) {
      //cas = cas.toString();
      var checkbox = document.getElementById(cas);
      if (checkbox.checked == true) {
        if (!chosenYears.includes(cas)) {
          chosenYears.push(cas);
        }
        document.getElementById("errorCheckbox").innerHTML = "";
      } else {
        if (chosenYears.length > 1) {
          var pos = chosenYears.indexOf(cas);
          chosenYears.splice(pos, 1);
        } else {
          checkbox.checked = true;
          document.getElementById("errorCheckbox").innerHTML = "Gardez au moins une année sélectionnée!";
        }
      }
      update(chosenYears, data.get_region_list());
    };

    function checkbox_create() {

      var subgroups_dur = data.get_year_list();
      var list_cocher = document.createElement('div');

      subgroups_dur.forEach(function (grp) {
        var cb = document.createElement('INPUT');
        cb.setAttribute("type", "checkbox");
        cb.setAttribute("id", grp);
        cb.setAttribute("name", grp);
        cb.setAttribute("checked", true);
        cb.setAttribute("onclick", "cocher_case(" + grp + ")");
        list_cocher.appendChild(cb);
        var label = document.createElement('label');
        label.setAttribute("for", grp);
        label.textContent = grp;
        list_cocher.appendChild(label);
      });

      var cocher = document.querySelector('#cocher');
      app.appendChild(list_cocher);
    }

  </script>
</body>

</html>