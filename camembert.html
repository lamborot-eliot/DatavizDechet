<!DOCTYPE html>
<html>
	<head>
		<title>Parcel Sandbox</title>
		<meta charset="UTF-8" />
		<script src="https://d3js.org/d3.v6.min.js"></script>
		<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script type="text/javascript" src="data_process.js"></script>
	</head>

	<style>
		div.tooltip {
			color: #222;
			background-color: #fff;
			padding: 0.5em;
			text-shadow: #f5f5f5 0 1px 0;
			border-radius: 2px;
			opacity: 0.9;
			position: absolute;
		}
	</style>
	<body>
		<div id="app"></div>

		<script>
			console.clear();
			var width = 450;
			var height = 450;
			var margin = 40;

			var radius = Math.min(width, height) / 2 - margin;

			var svg = d3
				.select("#app")
				.append("svg")
				.attr("width", width)
				.attr("height", height)
				.append("g")
				.attr(
					"transform",
					"translate(" + width / 2 + "," + height / 2 + ")"
				);

			var pie = d3.pie().value(function (d) {
				return d[1];
			});

			var colorRange = [
				"#e41a1c",
				"#377eb8",
				"#4daf4a",
				"#993A80",
				"#800000",
				"#ff9900",
				"#98928B"
			];

			var arcGenerator = d3.arc().innerRadius(0).outerRadius(radius);

			async function init() {
				data = await load_data();

				var data_dechet = {};
				for (const dechet in data.get_type_dechets()) {
					data_dechet[dechet] = Math.floor(data.get_dechet(dechet));
				}
				console.log(data_dechet);

				var color = d3
					.scaleOrdinal()
					.domain(Object.keys(data.get_type_dechets()).keys())
					.range(colorRange);

				var data_ready = pie(Object.entries(data_dechet));

				var tooltip = d3
					.select("#app")
					.append("div")
					.style("opacity", 0)
					.attr("class", "tooltip")
					.style("background-color", "white")
					.style("border", "solid")
					.style("border-width", "1px")
					.style("border-radius", "5px")
					.style("padding", "10px");

				var mousemove = function (event, d) {
					var subgroupName = data.get_type_dechets()[d.data[0]];
					var subgroupValue = Math.floor(d.data[1]);
					var mousePosition = d3.pointer(event);
					tooltip
						.style("opacity", 1)
						.attr(
							"style",
							"left:" +
								(mousePosition[0] + 125) +
								"px; top:" +
								(mousePosition[1] + 160) +
								"px"
						)
						.html(
							"DÃ©chets: " +
								subgroupName +
								"<br>" +
								"Valeur: " +
								subgroupValue +
								" tonnes" +
								"<br>" +
								"Pourcent: " +
								Number(
									(
										(d.data[1] * 100) /
										data.get_total_dechets()
									).toFixed(3)
								) +
								"%"
						);
				};
				var mouseleave = function (d) {
					tooltip.style("opacity", 0);
				};

				// Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
				svg.selectAll("mySlices")
					.data(data_ready)
					.enter()
					.append("path")
					.attr("d", arcGenerator)
					.attr("fill", function (d) {
						return color(d.data[0]);
					})
					.attr("stroke", "white")
					.on("mousemove", mousemove)
					.on("mouseleave", mouseleave)
					.style("stroke-width", "2px")
					.style("opacity", 0.7);
			}
			init();
		</script>
	</body>
</html>
