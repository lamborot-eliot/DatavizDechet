<!DOCTYPE html>
<head>
  <meta charset="utf-8" />
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script type="text/javascript" src="data_process.js"></script>
  <style>
    body {
      margin: 0;
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }
    div.tooltip {
      color: #222;
      background-color: #fff;
      padding: 0.5em;
      text-shadow: #f5f5f5 0 1px 0;
      border-radius: 2px;
      opacity: 0.9;
      position: absolute;
    }
  </style>
</head>

<body>
  <div>
    <input
      id="slider"
      type="range"
      value="2009"
      min="2009"
      max="2017"
      step="2"
    />
    <span id="year">Year: 2009</span>
    <select id="type_filtre" value="N" onchange="typeFilterChange()">
      <option value="N">Pas de Filtre</option>
      <option value="D">Type de Déchet</option>
      <option value="T">Type de Traitement</option>
    </select>
    <select id="type_dechet" value="N">
      <option value="N">Tous</option>
      <option id="02A" value="02A">02A</option>
      <option id="02B" value="02B">02B</option>
      <option id="02C" value="02C">02C</option>
      <option id="02D" value="02D">02D</option>
      <option id="02E" value="02E">02E</option>
      <option id="02F" value="02F">02F</option>
      <option id="02Z" value="02Z">02Z</option>
    </select>
  </div>
  <script>
    var width = 700,
      height = 580;

    var svg = d3
      .select("body")
      .append("svg")
      .attr("width", width)
      .attr("height", height);
    var tooltip = d3
      .select("body")
      .append("div")
      .attr("class", "hidden tooltip");

    // On rajoute un groupe englobant toute la visualisation pour plus tard
    var g = svg.append("g");

    var projection = d3
      .geoConicConformal()
      .center([2.454071, 46.279229])
      .scale([2800]);

    var path = d3.geoPath().projection(projection);

    var color = d3
      .scaleQuantize()
      .range(["#edf8e9", "#bae4b3", "#74c476", "#31a354", "#006d2c"]);

    //d3.csv("http://localhost:8888/data.csv").then(function (data) {
    //color.domain([0, 2000000]); //regle l'echelle ici
    //d3.json("regions-version-simplifiee.geojson").then(function (json) {
      d3.json("https://raw.githubusercontent.com/lamborot-eliot/DatavizDechet/main/departements-version-simplifiee.geojson").then(function (json) {
      //On fusionne les donnees avec le GeoJSON des regions

      load_data().then((data) => {
        var dict = {};
        var array_filter_type_service = data.get_type_services();
        var array_filter_type_dechet = data.get_type_dechets();
        var array_filter_type_service_orig = array_filter_type_service;
        var array_filter_type_dechet_orig = array_filter_type_dechet;
        //list of region
        var list_region = data.get_region_list();

        //Scaling
        var max_val = -1;
        var min_val = -1;

        var update_born = (y, max_res, min_res) => {
          if (max_res == -1) {
            max_res = y;
          } else {
            if (y > max_res) {
              max_res = y;
            }
          }
          if (min_res == -1) {
            min_res = y;
          } else {
            if (y < min_res) {
              min_res = y;
            }
          }
          return [max_res, min_res];
        };

        var updateViz = (max_val, min_val) => {
          let val = document.getElementById("slider").value;
          let type_dechet = document.getElementById("type_dechet").value;
          let type_filter = document.getElementById("type_filtre").value;
          d3.select("#year").html("Year: " + val);

          if (type_filter.localeCompare("N") == 0) {
            //we take everything
            array_filter_type_dechet = array_filter_type_dechet_orig;
            array_filter_type_service = array_filter_type_service_orig;

            max_val = -1;
            min_val = -1;
            dict = {};
            for (var j = 0; j < list_region.length; j++) {
              dict[list_region[j]] = data
                .get_region(list_region[j])
                .get_year(val)
                .get_total_dechets();
              var res = update_born(dict[list_region[j]], max_val, min_val);
              max_val = res[0];
              min_val = res[1];
            }
            document.getElementById("type_dechet").style.visibility = "hidden";
          } else {
            document.getElementById("type_dechet").style.visibility = "visible";
            if (type_filter.localeCompare("D") == 0) {
              if (type_dechet.localeCompare("N") == 0) {
                max_val = -1;
                min_val = -1;
                array_filter_type_dechet = array_filter_type_dechet_orig;
                array_filter_type_service = array_filter_type_service_orig;
                dict = {};
                for (var j = 0; j < list_region.length; j++) {
                  dict[list_region[j]] = data
                    .get_region(list_region[j])
                    .get_year(val)
                    .get_total_dechets();
                  var res = update_born(dict[list_region[j]], max_val, min_val);
                  max_val = res[0];
                  min_val = res[1];
                }
              } else {
                max_val = -1;
                min_val = -1;
                array_filter_type_dechet = [];
                array_filter_type_dechet[0] = type_dechet;
                array_filter_type_service = array_filter_type_service_orig;
                dict = {};
                for (var j = 0; j < list_region.length; j++) {
                  dict[list_region[j]] = data
                    .get_region(list_region[j])
                    .get_year(val)
                    .get_dechet(type_dechet);
                  var res = update_born(dict[list_region[j]], max_val, min_val);
                  max_val = res[0];
                  min_val = res[1];
                }
              }
            } else {
              if (type_dechet.localeCompare("N") == 0) {
                max_val = -1;
                min_val = -1;
                array_filter_type_dechet = array_filter_type_dechet_orig;
                array_filter_type_service = array_filter_type_service_orig;
                dict = {};
                for (var j = 0; j < list_region.length; j++) {
                  dict[list_region[j]] = data
                    .get_region(list_region[j])
                    .get_year(val)
                    .get_total_dechets();
                  var res = update_born(dict[list_region[j]], max_val, min_val);
                  max_val = res[0];
                  min_val = res[1];
                }
              } else {
                max_val = -1;
                min_val = -1;
                array_filter_type_dechet = [];
                array_filter_type_dechet[0] = type_dechet;
                array_filter_type_service = array_filter_type_service_orig;
                dict = {};
                for (var j = 0; j < list_region.length; j++) {
                  dict[list_region[j]] = data
                    .get_region(list_region[j])
                    .get_year(val)
                    .get_service(type_dechet);
                  var res = update_born(dict[list_region[j]], max_val, min_val);
                  max_val = res[0];
                  min_val = res[1];
                }
              }
            }
          }
          color.domain([min_val, max_val]); //regle l'echelle ici

          for (var i = 0; i < json.features.length; i++) {
            d3.select("#region" + json.features[i].properties.code).style(
              "fill",
              function (d) {
                // Si il n'y a aucune donnée on met en gris
                if (!dict[json.features[i].properties.code]) {
                  return "#ccc";
                }
                if (Object.keys(dict).length > 0) {
                  var value = dict[json.features[i].properties.code];
                }
                if (value == undefined) {
                  d.properties.value = "Pas de données";
                } else {
                  d.properties.value = value;
                }
                if (value !== undefined) {
                  return color(value);
                } else {
                  // si pas de valeur alors en gris
                  return "#ccc";
                }
              }
            );
          }
        };

        d3.select("#slider").on("input", function () {
          updateViz(max_val, min_val);
        });

        d3.select("#type_filtre").on("input", function () {
          updateViz(max_val, min_val);
        });
        d3.select("#type_dechet").on("input", function () {
          updateViz(max_val, min_val);
        });
        g.selectAll("path")
          .data(json.features)
          .enter()
          .append("path")
          .attr("d", path)
          .attr("id", function (d) {
            return "region" + d.properties.code;
          })
          .on("mousemove", (event, d) => {
            var mousePosition = d3.pointer(event);
            tooltip
              .style("opacity", 1)
              .attr(
                "style",
                "left:" +
                  (mousePosition[0] + 15) +
                  "px; top:" +
                  (mousePosition[1] - 35) +
                  "px"
              )
              .html(d.properties.nom + ": " + d.properties.value);
          })
          .on("mouseout", function () {
            tooltip.style("opacity", 0);
          });
        // On initialize la page
        document.getElementById("type_dechet").style.visibility = "hidden";
        updateViz(0, 2000000);
      });
    });
    function typeFilterChange() {
      var x = document.getElementById("type_filtre").value;
      if (x.localeCompare("D") == 0) {
        document.getElementById("type_dechet").value = "N";
        document.getElementById("02A").innerHTML = "Déchets dangereux";
        document.getElementById("02B").innerHTML = "Matériaux recyclables";
        document.getElementById("02C").innerHTML = "Déchets verts";
        document.getElementById("02D").innerHTML = "Encombrants";
        document.getElementById("02E").innerHTML = "Déblais et gravats";
        document.getElementById("02F").innerHTML = "DEEE";
        document.getElementById("02Z").innerHTML = "Autres déchets";
      } else {
        if (x.localeCompare("T") == 0) {
          document.getElementById("type_dechet").value = "N";
          document.getElementById("02A").innerHTML = "Valorisation matière";
          document.getElementById("02B").innerHTML =
            "Incinération avec récupération d'énergie";
          document.getElementById("02C").innerHTML = "Stockage";
          document.getElementById("02D").innerHTML = "Stockage pour inertes";
          document.getElementById("02E").innerHTML = "Non précisé";
          document.getElementById("02F").innerHTML = "Valorisation organique";
          document.getElementById("02Z").innerHTML =
            "Incinération sans récupération d'énergie";
        } else {
          document.getElementById("type_dechet").value = "N";
        }
      }
    }
  </script>
</body>
